# í¬íŒ… ë§¤ë‰´ì–¼

### 1. ë²„ì „ ì •ë³´

**Cloud Server**   **:  Amazon EC2**

**Web Server     :  Nginx**

**Image Server  :  AWS S3**

**DB Server        :  AWS RDS**

### Backend

```json
"Java"            : "OpenJDK 17.0.9"
"Spring"          : "5.3.30"
"Spring Boot"     : "2.7.17"
"Spring Security" : "5.7.11"
"Gradle"          : "8.3"
```

- **application.yml**

    ```yaml
    server:
        port: 8082
        tomcat:
            threads:
            max: 200
            min-spare: 10   
        accept-count: 100
        mbeanregistry:
            enabled: true
    spring:
        security:
            oauth2:
            client:
                registration:
                kakao:
                    client-id: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì•„ì´ë””]
                    client-secret: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì‹œí¬ë¦¿ í‚¤]
                    client-authentication-method: POST
                    authorization-grant-type: authorization_code
                    client-name: ë”©ë™
                    redirect-uri: https://ding-dong.kr/api/login/oauth2/code/kakao
                    scope: openid,profile_nickname,account_email

                provider:
                kakao:
                    issuer-uri: https://kauth.kakao.com
                    authorization-uri: https://kauth.kakao.com/oauth/authorize
                    token-uri: https://kauth.kakao.com/oauth/token
                    user-info-uri: https://kapi.kakao.com/v1/oidc/userinfo
                    jwk-set-uri: https://kauth.kakao.com/.well-known/jwks.json
                    user-name-attribute: id

    config:
        import: classpath:application-db.yml

    mvc:
        static-path-pattern: /static/**
        pathmatch:
        matching-strategy: ant_path_matcher

    auth:
        secretKey: [ì„œë¹„ìŠ¤ Signing Key]
        redirectUrl: https://ding-dong.kr
        ignored-urls: /member/login, /member/signup, /letter/guest, /auth/refresh, /swagger-ui/**, /swagger-resources/**, /v3/api-docs, /avatar/list, /yourstamp/**, /manage/**, /member/check/**, /room/**, /letter/sns/**, /member/logout, multi/**, /visitorbook/**

    letter:
        anonymous: [ìµëª…ì˜ ì´ì›ƒ UUID]
        password: DingDongDDingDong
        salt: LastPrjDingDong

    management:
        endpoints:
            web:
            exposure:
                include: prometheus, health, info
            base-path: /manage

    my:
        redirect-url: https://ding-dong.kr
    ```
    
- **application-db.yml**
    
    ```yaml
    spring:
    datasource:
        url: jdbc:mysql://[AWS RDS ì£¼ì†Œ]:8203/dingdong
        username: [DB Username]
        password: [DB password]
        driver-class-name: com.mysql.cj.jdbc.Driver

    data:
        mongodb:
        uri: mongodb+srv://S09P31B203:mIf01hEhzF@ssafy.ngivl.mongodb.net/S09P31B203?authSource=admin

    jpa:
        open-in-view: false
        show-sql: true
        hibernate:
        ddl-auto: update
        properties:
        hibernate:
            format_sql: true
    redis:
        host: [ë„ë©”ì¸ / ì„œë²„ ê³µì¸ IP]
        port: [Redis ì»¨í…Œì´ë„ˆ í¬íŠ¸]
        password: [Redis ë¹„ë°€ë²ˆí˜¸ ]

    ```

- **firebase_fcm.json**
    
    ```yaml
    {
        "type": "service_account",
        "project_id": "[FCM í”„ë¡œì íŠ¸ ID]",
        "private_key_id": "[FCM í”„ë¡œì íŠ¸ ë¹„ë°€ í‚¤ ID]",
        "private_key": "[FCM í”„ë¡œì íŠ¸ ë¹„ë°€ í‚¤]",
        "client_id": "[FCM í”„ë¡œì íŠ¸ Client ID]",
        "auth_uri": "https://accounts.google.com/o/oauth2/auth",
        "token_uri": "https://oauth2.googleapis.com/token",
        "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
        "client_x509_cert_url": "[ê³µê°œ x509 ì¸ì¦ì„œì˜ URL]",
        "universe_domain": "googleapis.com"
    }
    ```

- **.env**

    ```bash
    VITE_SERVER_URL = https://ding-dong.kr/dev/api
    VITE_KAKAO_JS_KEY = [KAKAO ê³µìœ í•˜ê¸° JS KEY]
    VITE_APP_GA_TRACKING_ID=[Google Analytics KEY ]

    VITE_APP_REGION=ap-northeast-2
    VITE_APP_ACCESS_KEY_ID=[S3 Bucket KEY]
    VITE_APP_SECRET_ACCESS_KEY_ID=[S3 Bucket KEY]

    VITE_APP_ROUTER_URL=

    VITE_APP_FCM_API_KEY=[FCM í”„ë¡œì íŠ¸ App ID]
    VITE_APP_AUTH_DOMAIN=[FCM í”„ë¡œì íŠ¸ App ID]
    VITE_APP_PROJECT_ID=[FCM í”„ë¡œì íŠ¸ App ID]
    VITE_APP_STORAGE_BUCKET=[FCM í”„ë¡œì íŠ¸ App ID]
    VITE_APP_MESSAGING_SENDER_ID=[FCM í”„ë¡œì íŠ¸ App ID]
    VITE_APP_APP_ID=[FCM í”„ë¡œì íŠ¸ App ID]
    VITE_APP_VAPID=[Web Push ì‹œ Device êµ¬ë¶„ì„ ìœ„í•œ ID]
    # í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ìƒì„±ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ë¶™ì—¬ë„£ê¸°
    ``` 
<aside>

ğŸš¨ Application ì„¤ì •íŒŒì¼ì€ ```ê³¼ê¸ˆ```ì´ ë  ìˆ˜ ìˆëŠ” ë¯¼ê°ì •ë³´ë“¤ì´ ì¡´ì¬í•˜ë¯€ë¡œ, ```Jenkins``` ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í™˜ê²½ì— ë³„ë„ë¡œ ì‘ì„±   
```
usr
 â”œ spring
 â”‚    â”” prod
 â”‚       â”” resources
 â”‚             â”œ application.yml
 â”‚             â”œ application-db.yml
 â”‚             â”” firebase
 â”‚                  â”” firebase_fcm.json
 â”‚
 â”” react
     â”” prod
         â”” .env
```

</aside>

### Frontend

```json
"React"          : "18.2.0"
"Recoil"         : "0.7.7"
"npm"            : "9.6.7"
"node.js"        : "18.17.0"
"Axios"          : "1.4.0"
"Vite"           : "4.4.5"
"Three.js"       : "0.157.0"
```

### Database

```json
"MySQL" : "8.0.33"
"Redis" : "7.2.2"
```

### Infra

```json
"Ubuntu"     : "20.0.4 LTS"
"Jenkins"    : "2.414.3"
"Docker"     : "24.0.6"
"Nginx"      : "1.18.0 (Ubuntu)"
"Prometheus" : "1.9.13"
"Grafana"    : "Latest"
```

### 2. í¬íŠ¸ ì •ë³´

| Port | ìš©ë„ | ê°œë°© |
| --- | --- | --- |
| 22 | SSH | â­• |
| 80 | NGINX | â­• |
| 443 | NGINX | â­• |
| 8888 | Jenkins | â­• |
| 8082 | BE PJT | âŒ |
| 3000 | FE PJT | âŒ |

### 3. EC2 ì‚¬ì „ ì„¤ì •

**Nginx**

```bash
$ sudo apt-get install nginx

# SSL ì¸ì¦ì„ ìœ„í•œ Certbot, LetsEncrypt
$ sudo apt-get install certbot python3-certbot-nginx
$ sudo apt-get install letsencrtypt

# Certbotì„ í†µí•œ SSL ì¸ì¦ì„œ ë°œê¸‰
$ sudo certbot --nginx
```

```bash
# Nginx ì„¤ì •íŒŒì¼
# /etc/nginx/conf.d/default.conf 
events {
    worker_connections 1024;
}

http {
     include            /etc/nginx/mime.types;
     default_type       text/html;

#     types {
#       model/gltf-binary glb;
#     }

     # ding-dong.krì— ëŒ€í•œ ë©”ì¸ ì„œë²„ ë¸”ë¡ ì„¤ì •

     # Rate Limiting
     limit_req_zone $binary_remote_addr:$uri zone=request_limit_per_ip:10m rate=3r/s;

     server {
        server_name ding-dong.kr;

        location / {
                proxy_pass http://localhost:3002;
        }

        location /feDev/ {
                proxy_pass http://localhost:3000/;
        }

        location /dev/ws/ {
                proxy_pass http://localhost:8080/ws/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
                proxy_set_header Host $host;
        }

        location /dev/api/ {
                proxy_pass http://localhost:8080/;
                proxy_set_header Connection '';
                proxy_http_version 1.1;
                proxy_read_timeout 86400;
                limit_req zone=request_limit_per_ip burst=5 delay=10;
                limit_req_status 429;
        }

        location /ws/ {
                proxy_pass http://localhost:8082/ws/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
                proxy_set_header Host $host;
        }

        location /api/ {
                proxy_pass http://localhost:8082/;
                proxy_set_header Connection '';
                proxy_http_version 1.1;
                proxy_read_timeout 86400;
                limit_req zone=request_limit_per_ip burst=5 delay=10;
                limit_req_status 429;
        }

        listen [::]:443 ssl ipv6only=on;
        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/ding-dong.kr/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/ding-dong.kr/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        
        }

    # k9b203.p.ssafy.ioì— ëŒ€í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì„¤ì •
    server {
        server_name k9b203.p.ssafy.io;

        # ëª¨ë“  ìš”ì²­ì„ ding-dong.krë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        location / {
            return 301 https://ding-dong.kr$request_uri;
        }

        ssl_certificate /etc/letsencrypt/live/k9b203.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/k9b203.p.ssafy.io/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # HTTP ìš”ì²­ì— ëŒ€í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì„¤ì •
    server {
	if ($host = ding-dong.kr) {
	       return 301 https://$host$request_uri;
	} # managed by Certbot

       	if ($host ~ ^(ding-dong\.kr|k9b203\.p\.ssafy\.io)$) {
	       return 301 https://$host$request_uri;
	}
       	listen 80;
	}
}

```

**Docker**

```bash
$ sudo apt-get update

# Docker ì„¤ì¹˜
# íŒ¨í‚¤ì§€ ì„¤ì¹˜
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
# Docker GPG í‚¤ ì¶”ê°€
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# Docker apt repository ì¶”ê°€
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io
```



### Jenkins

```bash
# Jenkins ì´ë¯¸ì§€ PULL
$ sudo docker pull jenkins/jenkins
# Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰ [ Docker Out Of Docker ë°©ì‹ì„ ìœ„í•œ docker.sock íŒŒì¼ ê³µìœ  ]
$ docker run -u root -it -v /var/run/docker.sock:/var/run/docker.sock -v /lib/modules:/lib/modules -p 8888:8080 --name jenkins jenkins/jenkins:lts
```

### Redis

```bash
# Redis ì´ë¯¸ì§€ PULL
$ sudo docker pull redis
# Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ sudo docker run -d -p 8225:6379 --name redis_prod redis
```

### 4. ë°°í¬

**Backend**

```docker
# BE Dockerfile
FROM openjdk:17-alpine

COPY build/libs/*.jar application.jar

EXPOSE 8082

ENTRYPOINT ["java","-jar", "-Duser.timezone=Asia/Seoul", "application.jar"]
```

```go
// BE Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_BE = "dingdong-springboot-prod"
                    APPLICATION_YML_PATH = "/usr/spring/prod/resources"
                    CONTAINER_NAME_BE = "dingdong_be_prod"
                    PROJECT_DIR_BE = "backend"
                }
            }
        }

        // ì„¤ì •íŒŒì¼ ì°¸ì¡°
        stage("COPY Resources") {
            steps {
                sh "cp -r ${APPLICATION_YML_PATH} ${PROJECT_DIR_BE}/src/main"
                sh "cp -r ${APPLICATION_YML_PATH} ${PROJECT_DIR_BE}/src/test"
            }
        }

        // ì†Œë‚˜íë¸Œ ì •ì ë¶„ì„
        stage("SonaQube Analyze") {
            steps {
                // withSonarQubeEnv('SonarQube_BE_Production') {
                    sh """
                    cd ${PROJECT_DIR_BE}
                    chmod 777 ./gradlew
                    ./gradlew sonar \
                    -Dsonar.projectKey=dingdong_be_prod \
                    -Dsonar.projectName='dingdong_be_prod' \
                    -Dsonar.host.url=http://k9b203.p.ssafy.io:9000 \
                    -Dsonar.token=sqp_ee86a56ef5a6a0f02b69ebc5303a281a332b11fb
                    """
                // }
            }
        }
        
        // ë°±ì—”ë“œ í”„ë¡œì íŠ¸ ë¹Œë“œ
        stage("BE Build") {
            steps{
                sh """
                cd ${PROJECT_DIR_BE}
                chmod 777 ./gradlew
                ls -al
                pwd
                ./gradlew clean build
                """
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("Container Cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker container stop"
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("Image Cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_BE} -q | xargs -r docker rmi -f"
            }
        }

        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("BE Image Build") {
            steps {
                sh """
                    cd ${PROJECT_DIR_BE}
                    docker build --no-cache -t ${IMAGE_NAME_BE} .
                """
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("Be Container Run") {
            steps {
                sh "docker run -d -p 8082:8082 --name ${CONTAINER_NAME_BE} ${IMAGE_NAME_BE} -e TZ=Asia/Seoul"
            }
        }


        // ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ì „ë¶€ ì‚­ì œ
        stage("Unused Resources Cleaning") {
            steps {
                sh "docker system prune -a -f"
            }
        }
    }
}
```

**Frontend**

```docker
FROM node:18-alpine AS build

CMD [ "cd", "/frontend" ]

COPY package.json .

RUN npm cache clean --force

RUN npm install

COPY . .

RUN npm run build

FROM nginx:1.21.3-alpine

COPY nginx.conf /etc/nginx/nginx.conf

COPY --from=build /dist /usr/share/nginx/html

EXPOSE 3000

CMD [ "nginx", "-g", "daemon off;" ]
```

```go
// Frontend Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_FE = "dingdong-react_prod"
                    CONTAINER_NAME_FE = "dingdong_fe_prod"
                    APPLICATION_ENV_PATH = "/usr/react/prod"
                    PROJECT_DIR_FE = "frontend"
                }
            }
        }

        // ì„¤ì •íŒŒì¼ ì°¸ì¡°
        stage("Copy env") {
            steps {
                sh "cp ${APPLICATION_ENV_PATH}/.env ${PROJECT_DIR_FE}"
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("Container Cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_FE} | xargs --no-run-if-empty docker container stop"    
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_FE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("Image Cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_FE} -q | xargs -r docker rmi -f"
            }
        }
        
        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("FE Image Build") {
            steps {
                sh """
                    cd ${PROJECT_DIR_FE}
                    docker build --no-cache -t ${IMAGE_NAME_FE} .
                """
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("Fe Container Run") {
            steps {
                script {
                    sh "docker run -d -p 3002:3000 --name ${CONTAINER_NAME_FE} ${IMAGE_NAME_FE}"
                }
            }
        }

        // ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ì „ë¶€ ì‚­ì œ
        stage("Unused Resources Cleaning") {
            steps {
                script {
                    sh "docker system prune -a -f"
                }
            }
        }

    }
}
```

### 5. ì™¸ë¶€ API

**KAKAO Login**

[Kakao Developers](https://developers.kakao.com/product/kakaoLogin)

**Firebase Cloud Messaging Web Push**

[Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging?hl=ko)
